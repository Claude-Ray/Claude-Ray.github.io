---
title: 缓存不当至服务崩溃
date: 2017-12-20 22:45:20
tags:
categories: Redis
description: 记录此次Bug原因和修复过程
---

### 问题描述

9月份优化的redis写缓存冲突，埋下了一个地雷。

回顾之前的解决方案：

recommend接口的返回值使用非常频繁，为了避免前端不断请求recommend接口，因此前端负责写缓存，后端负责从sql中查询数据，需要更新时再去删除此缓存。

这样就留下一个问题，当前端缓存过期，会迸发大量的请求到后端，当后端的sql查询速度较慢。此时前端的请求不间断，后端就堆积了大量的sql查询，影响到其他请求，甚至宕机。

之前没有出现问题的原因，是sql走了索引，查询速度正常。恰巧这个项目被交接之后，优化的过程中发现这条索引不合理，被删除了，但是遗漏了对recommend的修改，于是导致接口超时（查询时间大于Nginx配置的最大响应时间）。且缓存时间一周，等到它自然过期，被搞得措手不及。

### 解决方案

1. 立即为recommend设置一个非空缓存，停掉前端请求
2. 重启mysql
3. 恢复之前的索引，保证该接口下的SQL查询处于正常水平

> 旧索引恢复之后，一些优化就失效了，mysql继续走了它自认为不错的毒瘤索引。要即刻进行后续工作。

### 后续工作

1. 优化此处低效的sql(select xx where xx in xx order by，没有索引自然会崩)
2. 恢复后端在该接口下写缓存的能力，使用锁（redis.setnx）或让前端走请求方式获取
3. 重新删除上述索引，恢复正常优化